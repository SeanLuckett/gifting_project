(function($){

  var dfd = $.Deferred();
  window.fb_friends = dfd.promise();

  window.fbAsyncInit = function() {
     FB.init({
      appId   : <%= ENV['FACEBOOK_KEY'] %>,
      channelUrl: <%= "'//localhost:3000/channel.html'," unless Rails.env.production? %>
      status  : true,
      cookie  : true,
      xfbml   : true
    });

    FB.getLoginStatus(function(response){
      FB.api("/me/friends?fields=name,email,birthday", function(friends){
        if (friends.data.length > 0) {
          dfd.resolve( friends.data );
        } else {
          dfd.reject( "Something went wrong getting information on your Facebook friends.  Either you don't have any, yet or there was an error.  Try refreshing the page." );
        }
      });
    });
  };

})(jQuery);
